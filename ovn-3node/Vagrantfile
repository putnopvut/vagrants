ovn_repo         = "https://github.com/openvswitch/ovs.git"
ovn_branch       = "master"
ovn_pkg_dir      = "/vagrant/pkgs"

dmz_network="fd94:41f3:071a:9d54"
inside_network="fd94:41f3:071a:9d55"
mac_prefix="02:ac:10:ff:01"

#dmz vms

vm1="vm1"
mac1="#{mac_prefix}:30"
ip1="#{dmz_network}::2"

vm2="vm2"
mac2="#{mac_prefix}:31"
ip2="#{dmz_network}::3"

#inside vms

vm3="vm3"
mac3="#{mac_prefix}:94"
ip3="#{inside_network}::2"

vm4="vm4"
mac4="#{mac_prefix}:95"
ip4="#{inside_network}::3"


ovn_cfg = [
    {
     :name => "central",
     :box => "centos/7",
     :autostart => true,
     :host_name  => "central.ovn.dev",
     :ip => "192.168.33.11",
     :memory => 1536,
     :cpus => 1,
     :mtu => 1500,
     :nic_type => "virtio",
     :nic0 => "eth0",
     :nic1 => "eth1",
     :dmz_network => "#{dmz_network}::1/64",
     :dmz_mac => "#{mac_prefix}:29",
     :inside_network => "#{inside_network}::1/64",
     :inside_mac => "#{mac_prefix}:93",
   },{
     :name => "compute1",
     :box => "centos/7",
     :autostart => true,
     :host_name  => "compute1.ovn.dev",
     :ip => "192.168.33.31",
     :memory => 512,
     :cpus => 1,
     :mtu => 1500,
     :nic_type => "virtio",
     :nic0 => "eth0",
     :nic1 => "eth1",
     :dmz_ip => ip1,
     :dmz_mac => mac1,
     :dmz_vm => vm1,
     :inside_ip => ip3,
     :inside_mac => mac3,
     :inside_vm => vm3,
   },{
     :name => "compute2",
     :box => "centos/7",
     :autostart => true,
     :host_name  => "compute2.ovn.dev",
     :ip => "192.168.33.32",
     :memory => 512,
     :cpus => 1,
     :mtu => 1500,
     :nic_type => "virtio",
     :nic0 => "eth0",
     :nic1 => "eth1",
     :dmz_ip => ip2,
     :dmz_mac => mac2,
     :dmz_vm => vm2,
     :inside_ip => ip4,
     :inside_mac => mac4,
     :inside_vm => vm4,
   }
]

Vagrant.configure("2") do |config|

  ovn_cfg.each do |server|

    if server[:name] == "central"
        is_primary = true
    else
        is_primary = false
    end

    config.vm.define server[:name], primary: is_primary, autostart: server[:autostart] do |node|
      config.ssh.insert_key = false
      config.ssh.shell = "bash -c 'BASH_ENV=/etc/profile exec bash'" # avoids 'stdin: is not a tty' error.
      node.vm.box = server[:box]
      node.vm.box_check_update = false

      ovn_cfg.each do |entry|
          node.vm.provision "shell", inline: %Q(sudo sh -c "echo \\\"#{entry[:ip]} #{entry[:name]}\\\" >> /etc/hosts")
          node.vm.provision "shell", inline: %Q(sudo sh -c "setenforce 0")
      end

      node.vm.hostname = server[:host_name]
      node.vm.network :private_network, ip: server[:ip]

      config.vm.provider "libvirt" do |domain|
        domain.memory = server[:memory]
        domain.cpus = server[:cpus]
        domain.nic_model_type = server[:nic_type]
      end

      setup_args = "#{server[:ip]} #{ovn_repo} #{ovn_branch}"
      if server[:name] == "central"
          node.vm.provision "shell", path: "setup_central", :args => "#{setup_args}" 
          node.vm.provision "shell", path: "setup_routing_central", :args => "#{server[:dmz_network]} #{server[:inside_network]} #{server[:dmz_mac]} #{server[:inside_mac]}"
      else # compute node
          node.vm.provision "shell", path: "setup_controller", :args => "#{setup_args}"
          node.vm.provision "shell", path: "setup_routing_controller", :args => "#{server[:dmz_ip]} #{server[:dmz_mac]} #{server[:inside_ip]} #{server[:inside_mac]} #{server[:dmz_vm]} #{server[:inside_vm]}"
      end
    end
  end
end

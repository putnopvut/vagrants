#!/bin/bash
set -e

ovs-vsctl --may-exist add-br br-int

ovn-nbctl ls-add sw0

# add the router
ovn-nbctl lr-add ro0
ovn-nbctl set Logical_Router ro0 options:chassis=central

# create router port for the connection to sw0
ovn-nbctl lrp-add ro0 ro0-sw0 02:ac:10:ff:01:93 fd0f:0f07:71c6:af56::193/64

# create the sw0 switch port for connection to ro0
ovn-nbctl lsp-add sw0 sw0-ro0
ovn-nbctl lsp-set-type sw0-ro0 router
ovn-nbctl lsp-set-addresses sw0-ro0 02:ac:10:ff:01:93
ovn-nbctl lsp-set-options sw0-ro0 router-port=ro0-sw0

# sw0-vm1 will connect to vm1
ovn-nbctl lsp-add sw0 sw0-vm1
ovn-nbctl lsp-set-addresses sw0-vm1 "02:ac:10:ff:01:94 fd0f:0f07:71c6:af56::194"
ovn-nbctl lsp-set-port-security sw0-vm1 "02:ac:10:ff:01:94 fd0f:0f07:71c6:af56::194"

# sw0-vm2 will connect to vm2
ovn-nbctl lsp-add sw0 sw0-vm2
ovn-nbctl lsp-set-addresses sw0-vm2 "02:ac:10:ff:01:95 fd0f:0f07:71c6:af56::195"
ovn-nbctl lsp-set-port-security sw0-vm2 "02:ac:10:ff:01:95 fd0f:0f07:71c6:af56::195"

# Create a new switch for vm3 to connect to
ovn-nbctl lrp-add ro0 ro0-sw1 02:ac:10:ff:01:01 fd0f:0f07:71c6:b050::1/64
ovn-nbctl ls-add sw1
ovn-nbctl lsp-add sw1 sw1-ro0
ovn-nbctl lsp-set-type sw1-ro0 router
ovn-nbctl lsp-set-addresses sw1-ro0 02:ac:10:ff:01:01
ovn-nbctl lsp-set-options sw1-ro0 router-port=ro0-sw1
ovn-nbctl lsp-add sw1 sw1-vm3
ovn-nbctl lsp-set-addresses sw1-vm3 "02:ac:10:ff:01:02 fd0f:0f07:71c6:b050::2"
ovn-nbctl lsp-set-port-security sw1-vm3 "02:ac:10:ff:01:02 fd0f:0f07:71c6:b050::2"

sw0Dhcp="$(ovn-nbctl create DHCP_Options cidr="fd0f\:0f07\:71c6\:af56\:\:0/64" \
options="\"server_id\"=\"02:ac:10:ff:01:93\"")"
echo $sw0Dhcp

sw1Dhcp="$(ovn-nbctl create DHCP_Options cidr="fd0f\:0f07\:71c6\:b050\:\:0/64" \
options="\"server_id\"=\"02:ac:10:ff:01:01\"")"
echo $sw1Dhcp

ovn-nbctl lsp-set-dhcpv6-options sw0-vm1 $sw0Dhcp
ovn-nbctl lsp-get-dhcpv6-options sw0-vm1

ovn-nbctl lsp-set-dhcpv6-options sw0-vm2 $sw0Dhcp
ovn-nbctl lsp-get-dhcpv6-options sw0-vm2

ovn-nbctl lsp-set-dhcpv6-options sw1-vm3 $sw1Dhcp
ovn-nbctl lsp-get-dhcpv6-options sw1-vm3

echo "Setting up vm1"
ip netns add vm1
ovs-vsctl add-port br-int vm1 -- set interface vm1 type=internal
ip link set vm1 address 02:ac:10:ff:01:94
ip link set vm1 netns vm1
ovs-vsctl set Interface vm1 external_ids:iface-id=sw0-vm1
#ip netns exec vm1 ip addr add fd0f:0f07:71c6:af56::194 dev vm1
#ip netns exec vm1 ip -6 route add default via fd0f:0f07:71c6:af56::193
ip netns exec vm1 dhclient -6 --no-pid vm1
ip netns exec vm1 ip addr show vm1
ip netns exec vm1 ip route show

echo "Setting up vm2"
ip netns add vm2
ovs-vsctl add-port br-int vm2 -- set interface vm2 type=internal
ip link set vm2 address 02:ac:10:ff:01:95
ip link set vm2 netns vm2
ovs-vsctl set Interface vm2 external_ids:iface-id=sw0-vm2
#ip netns exec vm2 ip addr add fd0f:0f07:71c6:af56::195 dev vm2
#ip netns exec vm2 ip -6 route add default via fd0f:0f07:71c6:af56::193
ip netns exec vm2 dhclient -6 --no-pid vm2
ip netns exec vm2 ip addr show vm2
ip netns exec vm2 ip route show

echo "Setting up vm3"
ip netns add vm3
ovs-vsctl add-port br-int vm3 -- set interface vm3 type=internal
ip link set vm3 address 02:ac:10:ff:01:02
ip link set vm3 netns vm3
ovs-vsctl set Interface vm3 external_ids:iface-id=sw1-vm3
#ip netns exec vm3 ip addr add fd0f:0f07:71c6:b050::2 dev vm3
#ip netns exec vm3 ip -6 route add default via fd0f:0f07:71c6:b050::1
ip netns exec vm3 dhclient -6 --no-pid vm3
ip netns exec vm3 ip addr show vm3
ip netns exec vm3 ip route show

echo "Adding load balancer"
ovn-nbctl lb-add lb0 fd0f:0f07:71c6:b050::100 fd0f:0f07:71c6:af56::194,fd0f:0f07:71c6:af56::195
ovn-nbctl lr-lb-add ro0 lb0

mkdir /tmp/www
mkdir /tmp/www/vm1
echo "I am vm1" > /tmp/www/vm1/index.html
mkdir /tmp/www/vm2
echo "I am vm2" > /tmp/www/vm2/index.html
